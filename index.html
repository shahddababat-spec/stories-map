<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  // 1) أنشئ الخريطة (تفتح مباشرة على مخيم جنين)
  var map = L.map('map').setView([32.4603, 35.2952], 16);

  // 2) طبقة الخريطة
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
  }).addTo(map);

  // 3) حدود مخيم جنين (اختياري)
  var bounds = L.latLngBounds(
    [32.455, 35.288], // جنوب غرب
    [32.466, 35.302]  // شمال شرق
  );

  map.setMaxBounds(bounds);
  map.on('drag', function() {
    map.panInsideBounds(bounds, { animate: false });
  });

  // 4) اختيار نقطة على الخريطة
  var selectedLatLng = null;
  var tempMarker = null;

  map.on('click', function(e) {
    selectedLatLng = e.latlng;

    // (اختياري) إظهار ماركر مؤقت على مكان الاختيار
    if (tempMarker) map.removeLayer(tempMarker);
    tempMarker = L.marker(selectedLatLng).addTo(map);
  });

  // 5) إرسال القصة + الصورة (إن وجدت)
  async function submitStory() {
    if (!selectedLatLng) {
      alert("اختاري موقع على الخريطة أولاً");
      return;
    }

    let photoPayload = null;
    const file = document.getElementById("photo")?.files?.[0];

    if (file) {
      if (file.size > 2 * 1024 * 1024) {
        alert("الصورة كبيرة، اختاري صورة أصغر من 2MB");
        return;
      }

      const dataUrl = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });

      photoPayload = { fileName: file.name, dataUrl };
    }

    fetch("https://script.google.com/macros/s/AKfycbyk8zbGnixeXAsexnu3z2BCMdRaUd1QJvN-uBWxEN2jtbbWP65xd6WZQITRCJP1bb_Zpg/exec", {
      method: "POST",
      body: JSON.stringify({
        name: document.getElementById("name").value,
        title: document.getElementById("title").value,
        story: document.getElementById("story").value,
        category: document.getElementById("category").value,
        lat: selectedLatLng.lat,
        lng: selectedLatLng.lng,
        photo: photoPayload
      })
    })
    .then(res => res.json())
    .then(resp => {
      const imgHtml = resp.photo_url
        ? `<br><img src="${resp.photo_url}" style="max-width:220px;border-radius:10px;margin-top:6px;">`
        : "";

      L.marker(selectedLatLng).addTo(map)
        .bindPopup(`<b>${document.getElementById("title").value}</b><br>${document.getElementById("story").value}${imgHtml}`)
        .openPopup();

      document.getElementById("status").innerText = "✓ تم الحفظ";

      // تفريغ الفورم
      document.getElementById("photo").value = "";
    })
    .catch(() => {
      document.getElementById("status").innerText = "صار خطأ بالإرسال";
    });
  }
</script>




